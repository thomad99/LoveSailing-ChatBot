<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Quality Report - Sailing Database</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f8ff;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .logo-container {
      background-color: #020053;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 30px 0;
    }
    
    .logo-container img {
      max-width: 350px;
      height: auto;
    }
    
    .container {
      flex: 1;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .header {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      margin: 0 0 10px 0;
      color: #020053;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-card h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      opacity: 0.9;
    }
    
    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
    }
    
    .warning-card {
      background-color: #fff3cd;
      border: 2px solid #ffc107;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    
    .warning-card h2 {
      color: #856404;
      margin: 0 0 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .section h2 {
      color: #020053;
      margin: 0 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f8ff;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    table th, table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    
    table th {
      background-color: #020053;
      color: white;
      position: sticky;
      top: 0;
    }
    
    table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    table tr:hover {
      background-color: #f0f8ff;
    }
    
    .highlight {
      background-color: #fff3cd !important;
      font-weight: bold;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      color: #666;
    }
    
    .error {
      background-color: #f8d7da;
      border: 2px solid #dc3545;
      color: #721c24;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    button {
      background-color: #020053;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #040075;
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .nav-links {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
    }
    
    .nav-links a {
      color: #020053;
      text-decoration: none;
      margin-right: 20px;
      display: inline-block;
      padding: 8px 16px;
      border: 2px solid #020053;
      border-radius: 5px;
      transition: all 0.3s;
    }
    
    .nav-links a:hover {
      background-color: #020053;
      color: white;
    }
  </style>
</head>
<body>
  <div class="logo-container">
    <img src="img/LoveSailing-Wide.jpg" alt="Sailing Logo">
  </div>
  
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-chart-line"></i> Database Overview Report</h1>
      <p>Comprehensive statistics and insights from your sailing database</p>
      <div class="button-group">
        <button onclick="loadReport()"><i class="fas fa-sync-alt"></i> Refresh Report</button>
        <button onclick="exportReport()"><i class="fas fa-download"></i> Export to CSV</button>
      </div>
    </div>
    
    <div id="loading" class="loading">
      <i class="fas fa-spinner fa-spin"></i> Loading report...
    </div>
    
    <div id="error-container"></div>
    
    <div id="report-content" style="display: none;">
      <!-- Summary Stats -->
      <div class="stats-grid" id="stats-grid"></div>
      
      <!-- Data Quality Issues -->
      <div class="warning-card" id="warning-card" style="display: none;">
        <h2><i class="fas fa-exclamation-triangle"></i> Data Quality Issues Detected</h2>
        <p id="warning-text"></p>
      </div>
      
      <!-- Top Sailors -->
      <div class="section" id="top-sailors-section" style="display: none;">
        <h2><i class="fas fa-users"></i> Most Active Sailors</h2>
        <div style="overflow-x: auto;">
          <table id="top-sailors-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Skipper</th>
                <th>Club</th>
                <th>Total Races</th>
                <th>Avg Position</th>
              </tr>
            </thead>
            <tbody id="top-sailors-tbody"></tbody>
          </table>
        </div>
      </div>
      
      <!-- Recent Records -->
      <div class="section" id="recent-records-section" style="display: none;">
        <h2><i class="fas fa-clock"></i> Most Recent Records</h2>
        <div style="overflow-x: auto;">
          <table id="recent-records-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Regatta</th>
                <th>Date</th>
                <th>Skipper</th>
                <th>Boat Name</th>
                <th>Club</th>
                <th>Position</th>
              </tr>
            </thead>
            <tbody id="recent-records-tbody"></tbody>
          </table>
        </div>
      </div>
      
      <div class="nav-links">
        <a href="/chat"><i class="fas fa-comments"></i> Chat with Sailbot</a>
        <a href="/upload"><i class="fas fa-upload"></i> Upload Data</a>
      </div>
    </div>
  </div>
  
  <script>
    let reportData = null;
    
    async function loadReport() {
      const loadingDiv = document.getElementById('loading');
      const errorContainer = document.getElementById('error-container');
      const reportContent = document.getElementById('report-content');
      
      loadingDiv.style.display = 'block';
      errorContainer.innerHTML = '';
      reportContent.style.display = 'none';
      
      try {
        const response = await fetch('/api/data/data-quality-report?limit=100');
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to load report');
        }
        
        reportData = result.data;
        displayReport(reportData);
        
      } catch (error) {
        errorContainer.innerHTML = `<div class="error"><i class="fas fa-exclamation-circle"></i> Error: ${error.message}</div>`;
      } finally {
        loadingDiv.style.display = 'none';
        reportContent.style.display = 'block';
      }
    }
    
    function displayReport(data) {
      // Display summary stats
      const summary = data.summary;
      const statsGrid = document.getElementById('stats-grid');
      
      // Format dates
      const earliestDate = summary.earliest_date ? new Date(summary.earliest_date).toLocaleDateString() : '-';
      const latestDate = summary.latest_date ? new Date(summary.latest_date).toLocaleDateString() : '-';
      
      statsGrid.innerHTML = `
        <div class="stat-card">
          <h3>Total Records</h3>
          <div class="value">${summary.total_records.toLocaleString()}</div>
        </div>
        <div class="stat-card">
          <h3>Total Sailors</h3>
          <div class="value">${summary.total_sailors.toLocaleString()}</div>
        </div>
        <div class="stat-card">
          <h3>Total Regattas</h3>
          <div class="value">${summary.total_regattas.toLocaleString()}</div>
        </div>
        <div class="stat-card">
          <h3>Total Clubs</h3>
          <div class="value">${summary.total_clubs.toLocaleString()}</div>
        </div>
        <div class="stat-card">
          <h3>Earliest Race</h3>
          <div class="value" style="font-size: 20px;">${earliestDate}</div>
        </div>
        <div class="stat-card">
          <h3>Latest Race</h3>
          <div class="value" style="font-size: 20px;">${latestDate}</div>
        </div>
      `;
      
      // Display warning if missing data found
      if (summary.missing_skippers > 0 || summary.missing_boat_names > 0) {
        const warningCard = document.getElementById('warning-card');
        const warningText = document.getElementById('warning-text');
        let issues = [];
        if (summary.missing_skippers > 0) {
          issues.push(`${summary.missing_skippers.toLocaleString()} missing skippers`);
        }
        if (summary.missing_boat_names > 0) {
          issues.push(`${summary.missing_boat_names.toLocaleString()} missing boat names`);
        }
        warningText.textContent = `Found ${issues.join(' and ')}. Consider filling in these missing fields for better data quality.`;
        warningCard.style.display = 'block';
      } else {
        document.getElementById('warning-card').style.display = 'none';
      }
      
      // Display top sailors
      if (data.top_sailors && data.top_sailors.length > 0) {
        const topSailorsTbody = document.getElementById('top-sailors-tbody');
        topSailorsTbody.innerHTML = '';
        data.top_sailors.forEach((sailor, index) => {
          const row = document.createElement('tr');
          const avgPos = sailor.avg_position ? parseFloat(sailor.avg_position).toFixed(2) : '-';
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${sailor.skipper || '-'}</td>
            <td>${sailor.yacht_club || '-'}</td>
            <td>${sailor.race_count}</td>
            <td>${avgPos}</td>
          `;
          topSailorsTbody.appendChild(row);
        });
        document.getElementById('top-sailors-section').style.display = 'block';
      } else {
        document.getElementById('top-sailors-section').style.display = 'none';
      }
      
      // Display recent records
      if (data.recent_records && data.recent_records.length > 0) {
        const recentRecordsTbody = document.getElementById('recent-records-tbody');
        recentRecordsTbody.innerHTML = '';
        data.recent_records.forEach(record => {
          const row = document.createElement('tr');
          const date = record.regatta_date ? new Date(record.regatta_date).toLocaleDateString() : '-';
          row.innerHTML = `
            <td>${record.id}</td>
            <td>${record.regatta_name || '-'}</td>
            <td>${date}</td>
            <td>${record.skipper || '-'}</td>
            <td>${record.boat_name || '-'}</td>
            <td>${record.yacht_club || '-'}</td>
            <td>${record.position || '-'}</td>
          `;
          recentRecordsTbody.appendChild(row);
        });
        document.getElementById('recent-records-section').style.display = 'block';
      } else {
        document.getElementById('recent-records-section').style.display = 'none';
      }
    }
    
    function exportReport() {
      if (!reportData) {
        alert('Please load the report first');
        return;
      }
      
      // Create CSV content
      let csv = 'Database Overview Report\n\n';
      csv += `Total Records,${reportData.summary.total_records}\n`;
      csv += `Total Sailors,${reportData.summary.total_sailors}\n`;
      csv += `Total Regattas,${reportData.summary.total_regattas}\n`;
      csv += `Total Clubs,${reportData.summary.total_clubs}\n`;
      csv += `Earliest Date,${reportData.summary.earliest_date || '-'}\n`;
      csv += `Latest Date,${reportData.summary.latest_date || '-'}\n`;
      csv += `Missing Skippers,${reportData.summary.missing_skippers || 0}\n`;
      csv += `Missing Boat Names,${reportData.summary.missing_boat_names || 0}\n\n`;
      
      // Export top sailors
      csv += 'Top Sailors\n';
      csv += 'Rank,Skipper,Club,Total Races,Avg Position\n';
      reportData.top_sailors.forEach((sailor, index) => {
        const avgPos = sailor.avg_position ? parseFloat(sailor.avg_position).toFixed(2) : '-';
        csv += `${index + 1},"${sailor.skipper || '-'}","${sailor.yacht_club || '-'}",${sailor.race_count},${avgPos}\n`;
      });
      csv += '\n';
      
      // Export recent records
      csv += 'Recent Records\n';
      csv += 'ID,Regatta,Date,Skipper,Boat Name,Club,Position\n';
      reportData.recent_records.forEach(record => {
        const date = record.regatta_date ? new Date(record.regatta_date).toLocaleDateString() : '-';
        csv += `${record.id},"${record.regatta_name || '-'}",${date},"${record.skipper || '-'}","${record.boat_name || '-'}","${record.yacht_club || '-'}",${record.position || '-'}\n`;
      });
      
      // Download
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `database-report-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }
    
    // Load report on page load
    window.addEventListener('DOMContentLoaded', loadReport);
  </script>
</body>
</html>

